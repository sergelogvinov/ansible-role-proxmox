---

- include_vars: "{{ item }}"
  with_first_found:
    - "../vars/{{ ansible_distribution_release }}.yml"
    - "../vars/empty.yml"

- name: remove repo
  become: yes
  file:
    path: /etc/apt/sources.list.d/pve-enterprise.list
    state: absent
  register: repo

- name: update apt cache
  become: yes
  apt:
    update_cache: yes
  when: repo.changed

- name: install ifupdown2
  become: yes
  apt:
    name: "ifupdown2"
    state: present

- name: install proxmox-ve
  become: yes
  apt:
    name: "{{ proxmox_packages }}"
    state: present
  when: proxmox_packages|length > 0
  register: proxmox

- name: remove os-prober
  become: yes
  apt:
    name: os-prober
    state: absent
  when: proxmox.changed

- include_tasks:
    file: "{{ item }}"
  with_first_found:
    - "{{ ansible_bios_vendor|regex_replace('[ ,\\.]','') }}.yml"
    - "none.yml"

- name: firewall
  become: yes
  template:
    src: cluster.fw.j2
    dest: /etc/pve/firewall/cluster.fw
    owner: root
    group: www-data
    mode: 0640

- name: node firewall
  become: yes
  template:
    src: host.fw.j2
    dest: "/etc/pve/nodes/{{ ansible_hostname }}/host.fw"
    owner: root
    group: www-data
    mode: 0640
